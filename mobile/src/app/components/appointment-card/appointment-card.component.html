<ion-card [class.next-up]="isNextUp" [class.has-conflict]="appointment.hasConflict" [class.expanded]="expanded">

    <ion-card-content>
        <div class="card-layout">
            <!-- Left: Time -->
            <div class="time-column">
                <div class="start-time">{{ localStartTime }}</div>
                <div class="end-time">{{ localEndTime }}</div>
                <div *ngIf="isNextUp" class="countdown">{{ timeUntilStart }}</div>
            </div>

            <!-- Middle: Details -->
            <div class="details-column">
                <h3 class="patient-name">Patient: {{ appointment.user_id }}</h3>
                <p class="reference-id">{{ appointment.confirmationRef }}</p>

                <div class="status-row">
                    <ion-icon [name]="statusIcon" [color]="statusColor">
                    </ion-icon>
                    <span class="status-text">{{ appointment.status }}</span>

                    <ion-icon *ngIf="appointment.confirmationState !== 'CONFIRMED'" [name]="confirmationStateIcon"
                        [color]="confirmationStateColor" class="confirmation-icon">
                    </ion-icon>
                </div>

                <div *ngIf="appointment.hasConflict" class="conflict-warning">
                    <ion-icon name="warning" color="warning"></ion-icon>
                    <span>Scheduling conflict detected</span>
                    <ion-button fill="clear" size="small" (click)="handleViewConflict()">
                        View Details
                    </ion-button>
                </div>

                <!-- Expanded Details -->
                <div *ngIf="expanded" class="expanded-details">
                    <p><strong>Provider:</strong> {{ providerName }}</p>
                    <p><strong>Date:</strong> {{ localDate }}</p>
                    <p *ngIf="appointment.confirmedAt">
                        <strong>Confirmed at:</strong> {{ appointment.confirmedAt | date:'shortTime' }}
                    </p>
                </div>
            </div>

            <!-- Right: Actions -->
            <div class="actions-column">
                <ion-button *ngIf="showCheckIn" fill="solid" color="primary" size="small" (click)="handleCheckIn()">
                    Check In
                </ion-button>

                <ion-button fill="clear" size="small" [id]="'actions-' + appointment.id">
                    <ion-icon slot="icon-only" name="ellipsis-vertical"></ion-icon>
                </ion-button>
            </div>
        </div>
    </ion-card-content>

    <!-- Action Sheet Menu -->
    <ion-popover [trigger]="'actions-' + appointment.id" triggerAction="click">
        <ng-template>
            <ion-content>
                <ion-list>
                    <ion-item button (click)="toggleExpanded()">
                        <ion-icon name="information-circle" slot="start"></ion-icon>
                        <ion-label>{{ expanded ? 'Show Less' : 'Show More' }}</ion-label>
                    </ion-item>

                    <ion-item button (click)="handleReschedule()" [disabled]="appointment.status !== 'BOOKED'">
                        <ion-icon name="calendar" slot="start"></ion-icon>
                        <ion-label>Reschedule</ion-label>
                    </ion-item>

                    <ion-item button (click)="handleCancel()" [disabled]="appointment.status !== 'BOOKED'"
                        color="danger">
                        <ion-icon name="close-circle" slot="start"></ion-icon>
                        <ion-label>Cancel Appointment</ion-label>
                    </ion-item>
                </ion-list>
            </ion-content>
        </ng-template>
    </ion-popover>
</ion-card>